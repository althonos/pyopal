get_property(OPAL_CPP GLOBAL PROPERTY OPAL_CPP)

list(APPEND _PLATFORMS avx2 sse2 sse4 neon)
file(READ pyx.in TEMPLATE)

set(AVX2_DEFINE_MACROS "-D__AVX2__")
set(SSE2_DEFINE_MACROS "-D__SSE2__")
set(SSE4_DEFINE_MACROS "-D__SSE4_1__")
set(NEON_DEFINE_MACROS "-D__ARM_NEON__")

foreach(_simd IN LISTS _PLATFORMS)
    string(TOUPPER ${_simd} SIMD)
    if(HAVE_${SIMD})
        file(COPY_FILE ${OPAL_CPP} opal_${_simd}.cpp )
        configure_file(pyx.in ${_simd}.pyx)
        file(CONFIGURE CONTENT ${TEMPLATE} OUTPUT ${CMAKE_CURRENT_SOURCE_DIR}/${_simd}.pyx)
        cython_extension(${_simd} LINKS opal EXTRA_SOURCES opal_${_simd}.cpp)
        string(REPLACE " " ";" IMPL_FLAGS ${${SIMD}_C_FLAGS})
        foreach(_flag IN LISTS IMPL_FLAGS) 
           target_compile_options(pyopal.platform.${_simd} PRIVATE ${_flag})
           target_compile_definitions(pyopal.platform.${_simd} PRIVATE ${${SIMD}_DEFINE_MACROS})
        endforeach()
    endif()
endforeach()